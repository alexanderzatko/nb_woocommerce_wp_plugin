<?php

/**
 * @file
 * WooCommerce WordPress Plugin integration module for Na bežky!.
 * 
 * This module provides API endpoints for WordPress WooCommerce plugin
 * to generate vouchers and handle user authentication.
 */

/**
 * Implements hook_menu().
 */
function nb_woocommerce_wp_plugin_menu() {
  $items = array();
  
  // Admin configuration page
  $items['admin/config/services/nb_woocommerce_wp_plugin'] = array(
    'title' => t('WooCommerce WP Plugin Settings'),
    'description' => t('Configure settings for WordPress WooCommerce plugin integration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nb_woocommerce_wp_plugin_admin_form'),
    'access arguments' => array('administer site configuration'),
    'menu_name' => 'management'
  );
  
  return $items;
}

/**
 * Admin configuration form.
 */
function nb_woocommerce_wp_plugin_admin_form($form, &$form_state) {
  $form['info'] = array(
    '#type' => 'markup',
    '#markup' => '<div><strong>WooCommerce WordPress Plugin Integration</strong></div>',
  );
  
  $form['allowed_tokens'] = array(
    '#type' => 'textarea',
    '#title' => t('Allowed Access Tokens'),
    '#description' => t('Enter one access token per line. These tokens will be used to authenticate WordPress plugin requests.'),
    '#default_value' => implode("\n", variable_get('nb_woocommerce_wp_plugin_tokens', array())),
    '#rows' => 5,
  );
  
  $form['callback_timeout'] = array(
    '#type' => 'textfield',
    '#title' => t('Callback Timeout'),
    '#description' => t('Maximum time in seconds to wait for WordPress callback response.'),
    '#default_value' => variable_get('nb_woocommerce_wp_plugin_callback_timeout', 30),
    '#size' => 10,
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save Configuration'),
  );
  
  return $form;
}

/**
 * Admin form submit handler.
 */
function nb_woocommerce_wp_plugin_admin_form_submit($form, &$form_state) {
  $tokens = array_filter(array_map('trim', explode("\n", $form_state['values']['allowed_tokens'])));
  variable_set('nb_woocommerce_wp_plugin_tokens', $tokens);
  variable_set('nb_woocommerce_wp_plugin_callback_timeout', $form_state['values']['callback_timeout']);
  
  drupal_set_message(t('Configuration saved successfully.'));
}

/**
 * Access callback for Services endpoint.
 */
function nb_woocommerce_wp_plugin_access_check() {
  // Allow access to the endpoint - authentication is handled within the callback
  return TRUE;
}

/**
 * Services endpoint for voucher generation.
 * 
 * This function processes WooCommerce orders and generates appropriate vouchers.
 */
function nb_woocommerce_wp_plugin_voucher_generation($access_token, $order_data) {
  // Debug logging to track function parameters
  watchdog('nb_woocommerce_wp_plugin', 'Function called with parameters: <pre>@params</pre>', 
    array('@params' => print_r(array('access_token' => $access_token, 'order_data' => $order_data), TRUE)), WATCHDOG_DEBUG);
  
  // Validate access token first
  $allowed_tokens = variable_get('nb_woocommerce_wp_plugin_tokens', array());
  if (empty($allowed_tokens) || !in_array($access_token, $allowed_tokens)) {
    watchdog('nb_woocommerce_wp_plugin', 'Invalid access token used: @token', array('@token' => $access_token), WATCHDOG_WARNING);
    $error_response = array(
      'status' => 'error',
      'message' => 'Invalid or missing access token',
      'error_code' => 401
    );
    drupal_add_http_header('Content-Type', 'application/json');
    http_response_code(401);
    echo json_encode($error_response);
    drupal_exit();
  }
  
  // Validate required order data
  if (empty($order_data['email']) || empty($order_data['amount'])) {
    $error_response = array(
      'status' => 'error',
      'message' => 'Missing required order data',
      'error_code' => 400
    );
    drupal_add_http_header('Content-Type', 'application/json');
    http_response_code(400);
    echo json_encode($error_response);
    drupal_exit();
  }
  
  // Validate email format using existing Nabezky function
  if (!function_exists('nb_gmm_validate_email')) {
    watchdog('nb_woocommerce_wp_plugin', 'nb_gmm_validate_email function not found - nb_grooming_map module may not be enabled', array(), WATCHDOG_ERROR);
    $error_response = array(
      'status' => 'error',
      'message' => 'Required module not available',
      'error_code' => 500
    );
    drupal_add_http_header('Content-Type', 'application/json');
    http_response_code(500);
    echo json_encode($error_response);
    drupal_exit();
  }
  
  if (!nb_gmm_validate_email($order_data['email'])) {
    $error_response = array(
      'status' => 'error',
      'message' => 'Invalid email format',
      'error_code' => 400
    );
    drupal_add_http_header('Content-Type', 'application/json');
    http_response_code(400);
    echo json_encode($error_response);
    drupal_exit();
  }
  
  $email = $order_data['email'];
  $amount = floatval($order_data['amount']);
  $order_id = $order_data['order_id'];
  $region_id = isset($order_data['region_id']) ? intval($order_data['region_id']) : 1;
  
  watchdog('nb_woocommerce_wp_plugin', 'Processing WooCommerce order: @order_id, email: @email, amount: @amount, region_id: @region_id', 
    array('@order_id' => $order_id, '@email' => $email, '@amount' => $amount, '@region_id' => $region_id));
  
  try {
    // Check if user exists in Nabezky system
    $existing_user = nb_woocommerce_wp_plugin_find_user_by_email($email);
    $is_registered_user = ($existing_user !== FALSE);
    
    if ($is_registered_user) {
      watchdog('nb_woocommerce_wp_plugin', 'User lookup result: registered user found, uid: @uid', 
        array('@uid' => $existing_user->uid));
    } else {
      watchdog('nb_woocommerce_wp_plugin', 'User lookup result: anonymous user');
    }
    
    // Determine voucher type and quantity based on amount
    $season_pass_price = variable_get('nb_pass_cost', 20);
    
    watchdog('nb_woocommerce_wp_plugin', 'Voucher generation parameters - Amount: @amount, Season pass price: @price, Will generate: @type', 
      array('@amount' => $amount, '@price' => $season_pass_price, '@type' => ($amount >= $season_pass_price) ? 'seasonal' : '3day'));
    
    $voucher_data = array(
      'order_id' => $order_id,
      'email' => $email,
      'amount' => $amount,
      'is_registered_user' => $is_registered_user,
      'vouchers' => array(),
    );
    
    if ($is_registered_user) {
      // Handle registered user - update their access end date
      $result = nb_woocommerce_wp_plugin_process_registered_user($existing_user, $amount, $season_pass_price);
      if ($result === FALSE) {
        throw new Exception('Failed to process registered user order');
      }
      $voucher_data['user_uid'] = $existing_user->uid;
      $voucher_data['access_granted'] = TRUE;
    } else {
      // Generate vouchers for anonymous user
      $vouchers = nb_woocommerce_wp_plugin_get_or_create_voucher($amount, $region_id, $email, $season_pass_price);
      $voucher_data['vouchers'] = $vouchers;
      
      // Vouchers are generated but not claimed - claiming will happen when user uses voucher number
    }
    
    // Send email to customer
//    nb_woocommerce_wp_plugin_send_voucher_email($email, $voucher_data);
    
    watchdog('nb_woocommerce_wp_plugin', 'Successfully processed order @order_id', array('@order_id' => $order_id));
    
    // Return JSON response directly to avoid Drupal Services serialization
    $response = array(
      'status' => 'success',
      'message' => 'Voucher generated successfully',
      'voucher_data' => $voucher_data
    );
    
    // Set proper JSON headers and output
    drupal_add_http_header('Content-Type', 'application/json');
    drupal_add_http_header('Access-Control-Allow-Origin', '*');
    drupal_add_http_header('Access-Control-Allow-Methods', 'POST, OPTIONS');
    drupal_add_http_header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    
    // Output JSON and exit to prevent Drupal from processing further
    echo json_encode($response);
    drupal_exit();
    
  } catch (Exception $e) {
    watchdog('nb_woocommerce_wp_plugin', 'Error processing order @order_id: @error', 
      array('@order_id' => $order_id, '@error' => $e->getMessage()), WATCHDOG_ERROR);
    
    // Return JSON error response
    $error_response = array(
      'status' => 'error',
      'message' => 'Internal server error: ' . $e->getMessage(),
      'error_code' => 500
    );
    
    drupal_add_http_header('Content-Type', 'application/json');
    http_response_code(500);
    echo json_encode($error_response);
    drupal_exit();
  }
}

/**
 * Find user by email address using proper Drupal 7 methods.
 */
function nb_woocommerce_wp_plugin_find_user_by_email($email) {
  // Use standard Drupal 7 user loading approach
  $uid = db_select('users', 'u')
    ->fields('u', array('uid'))
    ->condition('mail', $email)
    ->condition('status', 1)
    ->range(0, 1)
    ->execute()
    ->fetchField();
  
  if ($uid) {
    $user = user_load($uid);
    if ($user && is_object($user) && isset($user->uid)) {
      watchdog('nb_woocommerce_wp_plugin', 'Found registered user for email @email, uid: @uid', 
        array('@email' => $email, '@uid' => $user->uid), WATCHDOG_INFO);
      return $user;
    }
  }
  
  watchdog('nb_woocommerce_wp_plugin', 'No registered user found for email @email', 
    array('@email' => $email), WATCHDOG_INFO);
  return FALSE;
}

/**
 * Process registered user order.
 */
function nb_woocommerce_wp_plugin_process_registered_user($user, $amount, $season_pass_price) {
  // Ensure we have a valid user object with uid
  if (!is_object($user) || !isset($user->uid)) {
    watchdog('nb_woocommerce_wp_plugin', 'Invalid user object passed to process_registered_user', array(), WATCHDOG_ERROR);
    return FALSE;
  }
  
  try {
    $usrobj = entity_metadata_wrapper('user', $user);
    
    if ($amount >= $season_pass_price) {
      // Seasonal pass - set access until end of season
      $end_date = rules_invoke_component('rules_end_of_ski_season')[0];
      $usrobj->field_cc_access_end_date->set($end_date);
    } else {
      // 3-day access - extend current access by 3 days
      $current_end = $usrobj->field_cc_access_end_date->value();
      $new_end = max($current_end, time()) + (3 * 24 * 60 * 60);
      $usrobj->field_cc_access_end_date->set($new_end);
    }
    
    $usrobj->save();
    
    return TRUE;
  } catch (Exception $e) {
    watchdog('nb_woocommerce_wp_plugin', 'Error processing registered user @uid: @error', 
      array('@uid' => $user->uid, '@error' => $e->getMessage()), WATCHDOG_ERROR);
    return FALSE;
  }
}

/**
 * Get or create vouchers using nb_grooming_map logic.
 * 
 * @param float $amount Payment amount
 * @param int $region_id Region ID (ski center ID)
 * @param string $email User email address
 * @param float $season_pass_price Season pass price threshold
 * @return array Array of voucher data or empty array on error
 */
function nb_woocommerce_wp_plugin_get_or_create_voucher($amount, $region_id, $email, $season_pass_price) {
  $vouchers = array();
  
  // Determine voucher type and quantity based on payment amount
  if ($amount >= $season_pass_price) {
    // Generate seasonal voucher
    watchdog('nb_woocommerce_wp_plugin', 'Creating seasonal voucher - Amount: @amount, Season pass price: @price', 
      array('@amount' => $amount, '@price' => $season_pass_price));

    $voucher_number = nb_woocommerce_wp_plugin_get_or_create_single_voucher($amount, $region_id, $season_pass_price);
    if ($voucher_number) {
      $vouchers[] = array(
        'number' => $voucher_number,
        'type' => 'seasonal',
        'expires' => rules_invoke_component('rules_end_of_ski_season')[0],
        'email' => $email,
      );
      watchdog('nb_woocommerce_wp_plugin', 'Generated seasonal voucher: @number', array('@number' => $voucher_number));
    }
  } else {
    // Generate 3-day vouchers
    $voucher_count = ceil($amount / 3);
    for ($i = 0; $i < $voucher_count; $i++) {
      $voucher_number = nb_woocommerce_wp_plugin_get_or_create_single_voucher($amount, $region_id, $season_pass_price);
      if ($voucher_number) {
        $vouchers[] = array(
          'number' => $voucher_number,
          'type' => '3day',
          'expires' => time() + (3 * 24 * 60 * 60),
          'email' => $email,
        );
      }
    }
  }
  
  return $vouchers;
}

/**
 * Get or create a single voucher using nb_grooming_map logic.
 * 
 * @param float $amount Payment amount
 * @param int $region_id Region ID (ski center ID)
 * @param float $season_pass_price Season pass price threshold
 * @return string|false Voucher number or FALSE on error
 */
function nb_woocommerce_wp_plugin_get_or_create_single_voucher($amount, $region_id, $season_pass_price) {
  // Determine voucher type based on payment amount
  $duration = ($amount >= $season_pass_price) ? 0 : 3; // 0 = seasonal, 3 = 3-day
  
  // Calculate season number (same logic as nb_grooming_map)
  $ess = rules_invoke_component('rules_end_of_ski_season');
  $season_end_year = (int)date('Y', $ess[0]);
  $seasonNum = (($season_end_year - 2024) % 9) + 1;
  
  // Look for existing unclaimed voucher
  $ski_center_id = str_pad($region_id, 2, '0', STR_PAD_LEFT);
  $prefix = $seasonNum . $ski_center_id . $duration;
  
  $existing_voucher = db_select('vouchers', 't')
    ->fields('t', array('voucher_number'))
    ->condition('holder_uid', NULL)
    ->condition('holder_email', NULL)
    ->condition('voucher_number', db_like($prefix) . '%', 'LIKE')
    ->where('LENGTH(CAST(voucher_number AS CHAR)) = :length', array(':length' => 13))
    ->range(0, 1)
    ->execute()
    ->fetchField();
  
  if ($existing_voucher) {
    watchdog('nb_woocommerce_wp_plugin', 'Found existing unclaimed voucher: @voucher', 
      array('@voucher' => $existing_voucher));
    return $existing_voucher;
  }
  
  // No existing voucher found, create new ones using nb_grooming_map logic
  if (!function_exists('nb_gmm_populate_vouchers_table_dva')) {
    watchdog('nb_woocommerce_wp_plugin', 'nb_gmm_populate_vouchers_table_dva function not found - nb_grooming_map module may not be enabled', array(), WATCHDOG_ERROR);
    return FALSE;
  }
  
  // Create vouchers using the grooming map module
  $ski_centers = array(
    array($region_id, ($duration == 3) ? 1 : 0, ($duration == 0) ? 1 : 0)
  );
  
  try {
    $created_count = nb_gmm_populate_vouchers_table_dva($ski_centers, 0, 999999999, 10, 9);
    
    if ($created_count > 0) {
      // Get one of the newly created vouchers
      $new_voucher = db_select('vouchers', 't')
        ->fields('t', array('voucher_number'))
        ->condition('holder_uid', NULL)
        ->condition('holder_email', NULL)
        ->condition('voucher_number', db_like($prefix) . '%', 'LIKE')
        ->where('LENGTH(CAST(voucher_number AS CHAR)) = :length', array(':length' => 13))
        ->range(0, 1)
        ->execute()
        ->fetchField();
      
      if ($new_voucher) {
        watchdog('nb_woocommerce_wp_plugin', 'Created new voucher: @voucher', 
          array('@voucher' => $new_voucher));
        return $new_voucher;
      }
    }
  } catch (Exception $e) {
    watchdog('nb_woocommerce_wp_plugin', 'Error creating vouchers: @error', 
      array('@error' => $e->getMessage()), WATCHDOG_ERROR);
  }
  
  return FALSE;
}




/**
 * Send voucher email to customer.
 */
function nb_woocommerce_wp_plugin_send_voucher_email($email, $voucher_data) {
  if ($voucher_data['is_registered_user']) {
    // Send email for registered user
    $subject = t('Na bežky! map - access granted');
    $message = t('Welcome back to the Na bežky! trails grooming status map.');
    $message .= '<br><br>';
    $message .= t('As a registered user, you now have access to all premium features including the interactive map.');
    $message .= '<br><br>';
    $message .= t('Thank you for supporting cross-country skiing in Slovakia');
  } else {
    // Send email with voucher information
    $subject = t('Na bežky! map - voucher verified');
    $message = t('Welcome to the Na bežky! trails grooming status map.');
    $message .= '<br><br>';
    $message .= t('Please make sure to save your voucher number, as you might need it in the future, for example if you for any reason clear cookies in your browser.');
    $message .= '<br><br>';
    
    foreach ($voucher_data['vouchers'] as $voucher) {
      $message .= '<strong>' . $voucher['number'] . '</strong><br>';
    }
    
    $message .= '<br><br>' . t('Thank you for supporting cross-country skiing in Slovakia');
  }
  
  // Send email using existing Nabezky email system
  rules_invoke_component('rules_send_email', $email, $subject, $message);
}
